<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit - Russian Club</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Global & Reset Styles (Matching Theme) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; 
            color: #f0f0f0; 
        }
        .container {
            max-width: 450px; 
            margin: 0 auto;
            padding: 0;
            background-color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Variables for Theme Consistency */
        :root {
            --header-height: 55px; 
            --accent-gold: #ffc700;
            --dark-bg-card: #252525;
            --deposit-green: #5cb85c;
        }
        
        /* ------------------- STICKY HEADER ------------------- */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 450px; 
            box-sizing: border-box; 
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            color: white; 
            display: flex;
            align-items: center;
            justify-content: space-between; 
            font-size: 1.2em;
            font-weight: 800;
            z-index: 1000;
            border-radius: 0 0 12px 12px;
            height: var(--header-height); 
            padding: 0 15px; 
            transition: all 0.3s ease;
        }

        .icon-btn {
            background: none;
            border: none;
            color: inherit; 
            font-size: 20px;
            cursor: pointer;
            width: 30px; 
            text-align: left;
            padding: 0;
            transition: color 0.3s ease;
        }

        .header-title {
            font-size: 1em;
            font-weight: 700;
            text-align: center;
            flex-grow: 1;
        }

        .header-spacer { 
            width: 30px; 
        }
        
        /* ------------------- MAIN CONTENT AREA ------------------- */
        .main-content {
            padding-top: var(--header-height);
            max-width: 450px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box; 
            padding-bottom: 30px;
        }
        
        /* ------------------- BALANCE CARD ------------------- */
        .balance-card {
            background: linear-gradient(135deg, #333333, #1a1a1a);
            border-radius: 15px;
            margin: 15px 15px 20px 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }
        .balance-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            height: 100px;
            background: linear-gradient(100deg, rgba(255, 199, 0, 0.3), rgba(255, 170, 0, 0.1));
            border-radius: 50% 50% 0 0;
            opacity: 0.2;
            transform: rotate(5deg);
        }
        .balance-info {
            position: relative;
            z-index: 10;
        }
        .balance-label {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .balance-value {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px; 
        }
        #accountHolderNameDisplay {
            justify-content: flex-start; 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 0.9em; 
            color: #ccc;
            align-self: flex-start;
        }
        .refresh-icon {
            color: #999;
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        .refresh-icon:active {
            transform: rotate(360deg);
        }
        .card-details {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        .balance-card .card-details:last-child {
            margin-top: 0; 
            position: absolute;
            bottom: 20px;
            right: 20px;
        }
        .card-icon {
            font-size: 2em;
            color: rgba(255, 199, 0, 0.8);
            margin-right: 0; 
        }
        
        
        /* ------------------- Phase 1: Selection Screen (Dark Theme) ------------------- */
        #selection-screen {
            display: block; 
            margin: 0 15px; 
            padding-bottom: 20px;
        }
        
        .section-header {
            font-size: 1.1em;
            color: var(--accent-gold); 
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .channel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px; 
            background-color: var(--dark-bg-card);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        .channel-option {
            background-color: #333; 
            padding: 15px 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            text-align: center;
        }
        .channel-option.selected {
            border-color: #ffc700; 
            background-color: #444;
        }
        .channel-option span:first-child {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .channel-option span:last-child {
            font-size: 0.8em;
            color: #aaa;
        }
        .amount-container {
            padding: 15px;
            background-color: var(--dark-bg-card);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }
        .amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .amount-option {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: bold;
        }
        .amount-option.selected {
            border-color: #ffc700;
            background-color: #4d3a00;
        }
        .custom-amount-input {
            width: 100%;
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 5px;
            box-sizing: border-box; 
        }
        .next-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--deposit-green), #4cae4c); 
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 15px rgba(92, 184, 92, 0.4); 
        }
        .instructions-list {
            list-style: none;
            padding: 0;
            font-size: 0.9em;
            color: #aaa;
        }
        .instructions-list li {
            margin-bottom: 8px;
            display: flex;
        }
        .instructions-list li::before {
            content: '♦';
            color: #ffc700;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        /* ------------------- Phase 2: Payment Details Screen (WHITE THEME) ------------------- */
        #payment-details-screen {
            display: none; 
            background-color: #ffffff; 
            padding: 20px;
            border-radius: 15px;
            color: #333; 
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            margin: 15px;
        }
        
        #payment-details-screen h3,
        #payment-details-screen h2 {
            color: #333; 
            font-size: 1.1em;
            margin-top: 0;
        }
        .payment-header {
            border-bottom: 1px dashed #ccc; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .amount-display {
            color: var(--deposit-green); 
            font-weight: bold;
            font-size: 1.4em;
        }
        .timer-box {
            color: #d9534f;
            font-weight: bold;
            padding: 5px 10px;
            border: 1px solid #d9534f;
            border-radius: 5px;
        }

        /* UPI and Copy Button Styling */
        .upi-line {
            display: flex;
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }
        .upi-line input[type="text"] {
            background-color: #f0f0f0; 
            color: #333; 
            border: none; 
            flex-grow: 1;
            padding: 7px;
            font-size: 1em;
        }
        .copy-button {
            /* Keep gold/dark theme for copy button */
            background-color: var(--accent-gold); 
            color: #1a1a1a;
            /* FIX: Ensure Copy UPI is highly visible */
            border: none;
            border-left: 2px solid #a07d00; 
            
            padding: 12px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            /* FIX APPLIED HERE: Increased min-width for full text visibility */
            min-width: 0px; 
        }
        .copy-button:active {
            background-color: #e0b400;
        }

        /* QR Code */
        #qrcode-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff; 
            padding: 10px 0;
            margin-top: 15px;
        }
        #qrcode-box {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }
        .qr-message {
            color: #555; 
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* App Icons Container Styling */
        .app-icons-container {
            display: flex;
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 20px;
            margin: 20px 0;
            padding: 10px 0;
            border-bottom: 1px dashed #ccc;
        }
        .app-icon-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            font-size: 0.85em;
            color: #333; 
            transition: transform 0.2s;
        }
        .app-icon-button img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 1px solid #eee;
        }

        /* UTR Form */
        .utr-form {
            padding-top: 10px;
        }
        .utr-form h3 {
            color: #333;
            border-top: 1px dashed #ccc; 
            padding-top: 15px;
            margin-bottom: 15px;
            font-size: 1em;
            font-weight: 600;
        }
        .utr-form input {
            width: 100%;
            padding: 12px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
        }
        .utr-warning {
            color: #d9534f; 
            font-size: 0.85em;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .confirm-button-final {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--deposit-green), #4cae4c); 
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 15px rgba(92, 184, 92, 0.4); 
        }
        
        /* ------------------- TOAST NOTIFICATION STYLES ------------------- */
        #toast-container {
            position: fixed; 
            top: 65px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 5000 !important; 
            width: 90%; 
            max-width: 400px;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="sticky-header" id="sticky-header">
            <button class="icon-btn" onclick="goBack()"><i class="fa fa-arrow-left"></i></button>
            <div class="header-title">Deposit</div>
            <div class="header-spacer"></div> 
        </div>
        
        <div class="main-content">

            <div class="balance-card" id="balance-header-card">
                <div class="balance-info">
                    <div class="balance-label">
                        <span>Available balance</span>
                        <i class="fa fa-sync refresh-icon" onclick="fetchBalance()"></i>
                    </div>
                    <div class="balance-value">₹<span id="availableBalance">0.00</span></div> 
                </div>
                <div id="accountHolderNameDisplay" class="card-details" style="justify-content: flex-start; margin-top: 25px; font-weight: bold; font-size: 0.9em; color: #ccc; align-self: flex-start;">USER ACCOUNT</div>
                
                <div class="card-details">
                    <i class="fa fa-credit-card card-icon"></i>
                </div>
            </div>
            <div id="selection-screen">
                <h2 class="section-header">Select Channel</h2>
                
                <div class="channel-grid" id="channel-selection-grid">
                    <div style="grid-column: 1 / span 2; text-align: center; color: #999;">Loading payment channels...</div>
                </div>

                <h2 class="section-header">Deposit amount</h2>
                
                <div class="amount-container">
                    <div class="amount-grid">
                        <div class="amount-option" data-amount="300" onclick="selectAmount(300)">₹ 300</div>
                        <div class="amount-option" data-amount="500" onclick="selectAmount(500)">₹ 500</div>
                        <div class="amount-option" data-amount="1000" onclick="selectAmount(1000)">₹ 1K</div>
                        <div class="amount-option" data-amount="10000" onclick="selectAmount(10000)">₹ 10K</div>
                        <div class="amount-option" data-amount="30000" onclick="selectAmount(30000)">₹ 30K</div>
                        <div class="amount-option" data-amount="50000" onclick="selectAmount(50000)">₹ 50K</div>
                    </div>
                    
                    <input type="number" id="depositAmount" class="custom-amount-input" placeholder="₹100.00 - ₹50,000.00" min="100" required>
                </div>

                <button class="next-button" onclick="goToPaymentDetails()">Proceed to Deposit</button>

                <h2 class="section-header" style="margin-top: 30px;">Recharge instructions</h2>
                <ul class="instructions-list">
                    <li>If the transfer time is up, please fill out the deposit form again.</li>
                    <li>The transfer amount must match the order you created, otherwise the money cannot be credited successfully.</li>
                    <li>If you transfer the wrong amount, our company will not be responsible for the lost amount!</li>
                    <li>Note: do not cancel the deposit order after the money has been transferred.</li>
                </ul>
            </div>

            <div id="payment-details-screen">
                <div class="payment-header">
                    <div class="amount-display" id="paymentAmountDisplay"></div>
                    <div class="timer-box" id="countdown">05:00</div>
                </div>
                
                <h3>Method: <span id="selectedChannelName"></span></h3>
                
                <div class="upi-line">
                    <input type="text" id="upi-current-input" value="" readonly>
                    <button class="copy-button" onclick="copyUpiId('upi-current-input')">Copy UPI</button>
                </div>

                <div id="qrcode-container">
                    <div id="qrcode-box"></div>
                    <div class="qr-message">Scan QR Code</div>
                </div>

                <div class="app-icons-container">
                    <a href="#" class="app-icon-button" onclick="clickToPay('phonepe')">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMbtAnBpNwjD2EsQqC9W2b56EjwhyUbhOu0AHr8b9TkQ&s=10/40/6739B7/FFFFFF?text=PP" alt="PhonePe">
                        <span>PhonePe</span>
                    </a>
                    <a href="#" class="app-icon-button" onclick="clickToPay('gpay')">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSztLBZfmzTPOY_xFBxiOP-EzEs2j_S2obBfbel7yhQWQ&s=10/40/4285F4/FFFFFF?text=GPay" alt="Google Pay">
                        <span>GPay</span>
                    </a>
                    <a href="#" class="app-icon-button" onclick="clickToPay('paytm')">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQsF4C34KpkYYhDtthFTe9yyHGr1kUinBQYRBNeVGE7Ug&s=10/40/00b9f1/FFFFFF?text=Paytm" alt="Paytm">
                        <span>Paytm</span>
                    </a>
                    <a href="#" class="app-icon-button" onclick="clickToPay('bhim')">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQJE4zv-Bn-NxHw83ugHHOtZQabKcQpof0F8n5V9T6XgMD7CdZtNjUkP_I&s=10/40/FF7400/FFFFFF?text=BHIM" alt="BHIM UPI">
                        <span>BHIM UPI</span>
                    </a>
                </div>
                
                <div class="utr-form">
                    <h3>Submit your UTR to complete the order faster.</h3>
                    <input type="text" id="utr" placeholder="Enter UTR/UPI reference ID (12 Digits)" maxlength="12" pattern="\d{12}" required>
                    
                    <p class="utr-warning">
                        ! Please ensure you enter the correct UTR.
                    </p>
                    
                    <button class="confirm-button-final" onclick="submitDeposit()">
                        Pay And Confirm
                    </button>
                </div>
            </div>

        </div>
        
    </div>

    <div id="toast-container"></div> 

    <script type="module">
        // --- CONSTANTS & CONFIG ---
        // IMPORTANT: Replace these with your actual Firebase Project Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDlEY_2bDv25T5GTCzTEk7sQIZrAxh5irc", 
            authDomain: "russian-club.firebaseapp.com",
            projectId: "russian-club",
            storageBucket: "russian-club.firebasestorage.app",
            messagingSenderId: "659659196153",
            appId: "1:659659196153:web:d6aaa4650fcff3d5fa0428",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const db = firebase.firestore();
        // Assume UID is stored after login
        let currentUID = localStorage.getItem('loggedInUserUID'); 
        let userBalance = 0; 

        // DOM Elements
        const balanceDisplayEl = document.getElementById('availableBalance');
        const holderNameEl = document.getElementById('accountHolderNameDisplay');
        const stickyHeader = document.getElementById('sticky-header'); 
        const channelGrid = document.getElementById('channel-selection-grid');

        // Global variable to store fetched UPI data
        let upiChannelMap = {}; 
        
        // Default channels to initialize the Firestore collection if it's empty
        const defaultUpiChannels = {
            sgpay: { id: 'mushkanbabu@ybl', name: 'SG Pay Services', min: 100 }, 
            crpay: { id: 'chandxrajni@ybl', name: 'CR Pay Agent', min: 100 },
            fastupi: { id: 'fastupi-rc@payment', name: 'Fast UPI', min: 300 },
            russiapay: { id: 'russiapay@upi', name: 'Russian Pay', min: 500 },
        };
        
        let selectedChannel = null;
        let finalDepositAmount = 0;
        let countdownInterval;

        // UPI App deep link prefixes
        const appLinkPrefixes = {
            phonepe: 'phonepe://pay',
            gpay: 'tez://upi/pay', 
            paytm: 'paytmmp://pay',
            bhim: 'bhim://upi/pay',
            default: 'upi://pay' 
        };
        

        // --- HELPER FUNCTIONS ---
        function formatCurrency(amount) {
            return Number(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function goBack() {
            if (document.getElementById('payment-details-screen').style.display === 'block') {
                clearInterval(countdownInterval); 
                
                // Reset theme to Dark
                document.querySelector('.container').style.backgroundColor = '#1a1a1a';
                stickyHeader.style.background = 'rgba(255, 255, 255, 0.08)';
                stickyHeader.style.backdropFilter = 'blur(12px) saturate(180%)';
                stickyHeader.style.webkitBackdropFilter = 'blur(12px) saturate(180%)';
                stickyHeader.style.borderBottom = '1px solid rgba(255, 255, 255, 0.25)';
                stickyHeader.style.color = 'white';
                
                document.getElementById('balance-header-card').style.display = 'flex'; 
                document.getElementById('payment-details-screen').style.display = 'none';
                document.getElementById('selection-screen').style.display = 'block';
            } else {
                history.back();
            }
        }
        window.goBack = goBack; 

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.style.padding = '12px 20px';
            toast.style.marginBottom = '10px';
            toast.style.borderRadius = '8px';
            toast.style.fontSize = '0.95em';
            toast.style.fontWeight = '600';
            toast.style.color = 'white';
            toast.style.textAlign = 'center';
            toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.4)';
            toast.style.background = type === 'success' ? '#28a745' : '#dc3545';
            
            toast.textContent = message;
            container.prepend(toast); 
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 400); 
            }, 4000); 
        }

        // --- BALANCE & USERNAME FETCH ---
        async function fetchBalance() {
            if (!currentUID) {
                balanceDisplayEl.textContent = '0.00';
                holderNameEl.textContent = 'LOG IN REQUIRED';
                return;
            }

            const userRef = db.collection('users').doc(currentUID);
            try {
                const doc = await userRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    userBalance = data.balance || 0; 
                    
                    balanceDisplayEl.textContent = formatCurrency(userBalance);
                    
                    // Show username if available, otherwise show full name
                    const display_name = (data.username || data.full_name || 'USER ACCOUNT').toUpperCase();
                    holderNameEl.textContent = display_name;
                    
                } else {
                    balanceDisplayEl.textContent = '0.00';
                    holderNameEl.textContent = 'USER ACCOUNT';
                }
            } catch (error) {
                console.error("Error fetching balance:", error);
                showToast('Failed to fetch balance. Try refreshing.', 'error');
            }
        }
        window.fetchBalance = fetchBalance; 
        
        // --- UPI CHANNEL INITIALIZATION & FETCH ---
        
        // Step 1: Initialize (create defaults if empty)
        async function initializeUpiChannels() {
            try {
                const snapshot = await db.collection('upi_channels').limit(1).get();
                
                if (snapshot.empty) {
                    console.log("UPI channels collection is empty. Creating default channels...");
                    
                    const batch = db.batch();
                    let count = 0;
                    
                    for (const key in defaultUpiChannels) {
                        if (defaultUpiChannels.hasOwnProperty(key)) {
                            const channelRef = db.collection('upi_channels').doc(key);
                            batch.set(channelRef, defaultUpiChannels[key]);
                            count++;
                        }
                    }
                    
                    await batch.commit();
                    console.log(`${count} default UPI channels created successfully.`);
                }
                
                // Step 2: Fetch and display the channels
                await fetchUpiChannels();

            } catch (error) {
                console.error("Error during UPI channel initialization:", error);
                channelGrid.innerHTML = `<div style="grid-column: 1 / span 2; color: #d9534f;">Critical Error: Failed to initialize channels. Check Firebase rules.</div>`;
                showToast('Critical error in loading channels. Check console.', 'error');
            }
        }
        
        // Step 2: Fetch (used after initialization)
        async function fetchUpiChannels() {
            try {
                const snapshot = await db.collection('upi_channels').get();
                upiChannelMap = {};
                
                if (snapshot.empty) {
                    channelGrid.innerHTML = `<div style="grid-column: 1 / span 2; color: #d9534f; font-weight: bold;">No payment channels found.</div>`;
                    return;
                }

                let firstChannelId = null;
                channelGrid.innerHTML = ''; 

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const channelId = doc.id;
                    upiChannelMap[channelId] = data;
                    
                    // Create the channel selection element
                    const optionEl = document.createElement('div');
                    optionEl.className = 'channel-option';
                    optionEl.setAttribute('data-channel-id', channelId);
                    optionEl.setAttribute('onclick', `selectChannel('${channelId}')`);
                    optionEl.innerHTML = `
                        <span>${data.name}</span>
                        <span>Balance: ₹${data.min} - ₹50K</span>
                    `;
                    channelGrid.appendChild(optionEl);

                    if (!firstChannelId) {
                        firstChannelId = channelId;
                    }
                });

                // Auto-select the first channel loaded
                if (firstChannelId) {
                    selectChannel(firstChannelId);
                }

            } catch (error) {
                console.error("Error fetching UPI channels:", error);
                channelGrid.innerHTML = `<div style="grid-column: 1 / span 2; color: #d9534f;">Failed to display channels.</div>`;
                showToast('Failed to display payment channels.', 'error');
            }
        }
        
        // --- CORE DEPOSIT LOGIC ---

        function selectChannel(channelId) {
            document.querySelectorAll('.channel-option').forEach(el => el.classList.remove('selected'));
            const selectedElement = document.querySelector(`.channel-option[data-channel-id="${channelId}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
                selectedChannel = channelId;
                
                const minAmount = upiChannelMap[channelId].min;
                document.getElementById('depositAmount').min = minAmount;
                document.getElementById('depositAmount').placeholder = `₹${minAmount}.00 - ₹50,000.00`;

                document.querySelectorAll('.amount-option').forEach(el => el.classList.remove('selected'));
                document.getElementById('depositAmount').value = '';
            }
        }
        window.selectChannel = selectChannel;

        function selectAmount(amount) {
            document.querySelectorAll('.amount-option').forEach(el => el.classList.remove('selected'));
            const selectedElement = document.querySelector(`.amount-option[data-amount="${amount}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            document.getElementById('depositAmount').value = amount;
        }
        window.selectAmount = selectAmount;
        
        function goToPaymentDetails() {
            if (!currentUID) {
                showToast('Please log in to proceed with a deposit.', 'error');
                return;
            }
            
            if (!selectedChannel || !upiChannelMap[selectedChannel]) {
                showToast("Please select a valid payment channel first.", 'error');
                return;
            }

            const amountInput = document.getElementById('depositAmount');
            const amount = parseFloat(amountInput.value);
            const minAllowed = upiChannelMap[selectedChannel].min;
            
            if (isNaN(amount) || amount < minAllowed || amount > 50000) {
                showToast(`Please enter a valid amount between ₹${minAllowed} and ₹50,000.`, 'error');
                return;
            }
            
            finalDepositAmount = amount.toFixed(2);
            const currentChannel = upiChannelMap[selectedChannel];

            // Apply White Theme Changes
            document.querySelector('.container').style.backgroundColor = '#ffffff'; 
            stickyHeader.style.background = '#ffffff'; 
            stickyHeader.style.backdropFilter = 'none';
            stickyHeader.style.webkitBackdropFilter = 'none';
            stickyHeader.style.borderBottom = '1px solid #ccc';
            stickyHeader.style.color = '#333'; 
            
            // Switch UI screens
            document.getElementById('balance-header-card').style.display = 'none';
            document.getElementById('selection-screen').style.display = 'none';
            document.getElementById('payment-details-screen').style.display = 'block';
            
            // Set data
            document.getElementById('selectedChannelName').textContent = currentChannel.name;
            document.getElementById('paymentAmountDisplay').textContent = `₹${finalDepositAmount}`;
            document.getElementById('upi-current-input').value = currentChannel.id;
            
            generateQRCode(currentChannel.id, currentChannel.name, 'qrcode-box', finalDepositAmount);
            startCountdown();
        }
        window.goToPaymentDetails = goToPaymentDetails;

        function generateQRCode(upiId, upiName, containerId, amount) {
            document.getElementById(containerId).innerHTML = ''; 
            const upiData = `upi://pay?pa=${upiId}&pn=${upiName}&am=${amount}&cu=INR`;
            
            new QRCode(document.getElementById(containerId), {
                text: upiData,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }
        
        function copyUpiId(elementId) {
            const inputElement = document.getElementById(elementId);
            inputElement.select();
            inputElement.setSelectionRange(0, 99999); 
            document.execCommand('copy');
            showToast(`"${inputElement.value}" copied to clipboard!`, 'success');
        }
        window.copyUpiId = copyUpiId;
        
        function clickToPay(appName) {
             const currentChannel = upiChannelMap[selectedChannel];
             const upiId = currentChannel.id;
             const upiPayString = `pa=${upiId}&pn=${currentChannel.name}&am=${finalDepositAmount}&cu=INR`;
             let deepLink;
             
             if (appLinkPrefixes[appName]) {
                 deepLink = `${appLinkPrefixes[appName]}?${upiPayString}`;
             } else {
                 deepLink = `upi://pay?${upiPayString}`;
             }
             
             window.location.href = deepLink;
        }
        window.clickToPay = clickToPay;


        // 5 Minute Timer
        function startCountdown() {
            clearInterval(countdownInterval); 
            let timeInSeconds = 5 * 60; 
            const countdownEl = document.getElementById('countdown');

            countdownInterval = setInterval(() => {
                const minutes = Math.floor(timeInSeconds / 60);
                let seconds = timeInSeconds % 60;

                seconds = seconds < 10 ? '0' + seconds : seconds;

                countdownEl.innerHTML = `${minutes}:${seconds}`;

                if (timeInSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownEl.innerHTML = "00:00";
                    showToast("Time expired! Please start a new transaction.", 'error');
                } else {
                    timeInSeconds--;
                }
            }, 1000);
        }
        
        // Final function to save deposit request to Firestore (creates collection if non-existent)
        async function submitDeposit() {
            const utr = document.getElementById('utr').value;
            
            if (utr.length !== 12 || isNaN(utr)) {
                showToast("Please enter a correct 12-digit UTR/Reference ID.", 'error');
                return;
            }
            
            if (!currentUID) {
                showToast("Error: User not authenticated. Please log in first.", 'error');
                return;
            }

            const currentChannel = upiChannelMap[selectedChannel];
            const orderNumber = 'DEP' + Date.now().toString();

            const depositData = {
                uid: currentUID, 
                amount: parseFloat(finalDepositAmount),
                channel: selectedChannel,
                channelName: currentChannel.name,
                upiId: currentChannel.id,
                utrReference: utr,
                order_number: orderNumber,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'Pending', 
                type: 'Deposit' 
            };
            
            document.getElementById('utr').disabled = true;
            document.querySelector('.confirm-button-final').textContent = 'Submitting...';
            document.querySelector('.confirm-button-final').disabled = true;


            try {
                // This line will create 'deposit_requests' collection if it doesn't exist.
                const docRef = await db.collection("deposit_requests").add(depositData);
                
                showToast(`✅ Deposit Request for ₹${formatCurrency(depositData.amount)} submitted!`, 'success');
                
                setTimeout(() => {
                    document.querySelector('.container').style.backgroundColor = '#1a1a1a';
                    window.location.reload(); 
                }, 3000); 

            } catch (error) {
                console.error("Error writing deposit document: ", error);
                showToast("❌ Deposit failed to save to database. Please try again or contact support.", 'error');
            } finally {
                 document.getElementById('utr').disabled = false;
                 document.querySelector('.confirm-button-final').textContent = 'Pay And Confirm';
                 document.querySelector('.confirm-button-final').disabled = false;
            }
        }
        window.submitDeposit = submitDeposit;
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Initial Data Fetch
             fetchBalance();
             
             // 2. Initialize and load UPI Channels (handles creation if empty)
             initializeUpiChannels(); 

             // 3. Initial Setup
             document.getElementById('depositAmount').placeholder = '₹100.00 - ₹50,000.00';
        });
    </script>

</body>
</html>
