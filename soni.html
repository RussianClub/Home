<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian Club - Admin Panel (Firebase Auth Secured)</title>
    <link rel="stylesheet" href="rajni.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script src="firebaseConfig.js"></script>
    
    <style>
        /* ADDED STYLES FOR PAYMENT CHANNELS MANAGEMENT (for better look) */
        .channel-card {
            background-color: #252525;
            border-left: 5px solid #ffc700;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
        }
        .channel-card h4 {
            margin-top: 0;
            color: #ffc700;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .channel-card p {
            font-size: 0.9em;
            color: #ccc;
            margin: 5px 0;
        }
        .channel-card button {
            margin-top: 10px;
            padding: 8px 15px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            align-self: flex-start; /* Button on the left */
        }
        .channel-card button:hover {
            background-color: #4cae4c;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="logo-text">
                <span class="russian-color">ADMIN</span><span class="club-color">LOGIN</span>
            </div>

            <form id="loginForm">
                <div class="input-group">
                    <label for="username">Admin Email ID</label>
                    <input type="email" id="username" required> 
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                
                <button type="submit" class="login-btn">Log In</button>
                <div id="loginMessage"></div>
            </form>
        </div>
    </div>


    <div id="dashboardWrapper" class="dashboard-wrapper">
        
        <div class="sidebar">
            <div class="logo-header">
                <div class="logo-text">
                    <span class="russian-color">ADMIN</span><span class="club-color">PANEL</span>
                </div>
            </div>

            <a href="#" class="nav-link active" data-tab="dashboard">
                <i class="fa fa-dashboard"></i> <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" data-tab="announcements">
                <i class="fa fa-bullhorn"></i> <span>Announcements</span>
            </a>
            <a href="#" class="nav-link" data-tab="paymentChannels">
                <i class="fa fa-bank"></i> <span>Payment Channels</span>
            </a>
            </div>

        <div class="main-panel">
            
            <div class="header-bar">
                <h2 id="welcomeMessage">Welcome, Admin!</h2>
                <div class="search-container">
                    <input type="text" id="globalSearch" placeholder="Search by UID, Username, UTR, etc...">
                </div>
                <button class="logout-btn" onclick="logoutAdmin()">Logout <i class="fa fa-sign-out"></i></button>
            </div>

            <div id="dashboard" class="tab-content active">
                <h3>üìà Site Overview</h3>
                <div class="dashboard-grid">
                    <div class="widget">
                        <div class="widget-title">Total Users</div>
                        <div class="widget-value" id="totalUsersCount">Loading...</div>
                    </div>
                    <div class="widget">
                        <div class="widget-title">Total Deposits (Pending)</div>
                        <div class="widget-value" id="pendingDepositsCount">Loading...</div>
                    </div>
                    <div class="widget">
                        <div class="widget-title">Total Withdrawals (Pending)</div>
                        <div class="widget-value pink" id="pendingWithdrawals">Loading...</div>
                    </div>
                    <div class="widget">
                        <div class="widget-title">Total Balance (Users)</div>
                        <div class="widget-value" id="totalUserBalance">Loading...</div>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <h3>Recent Activity Feed</h3>
                    <p style="color: #999;">Data will be updated from Firebase...</p>
                </div>
            </div>

            <div id="announcements" class="tab-content">
                <div class="data-table-container">
                    <h3>üì£ Manage Site Announcements</h3>
                    <button class="action-btn" style="background-color: var(--accent-gold); color: var(--dark-bg); margin-top: 10px;" onclick="addAnnouncement()">+ Create New Announcement</button>
                    <div class="announcement-list" id="announcementList">
                        <p style="color: #999;">Loading announcements...</p>
                    </div>
                </div>
            </div>
            
            <div id="paymentChannels" class="tab-content">
                <div class="data-table-container">
                    <h3>üè¶ Manage UPI Payment Channels</h3>
                    <p style="color: #ccc; margin-bottom: 20px;">Edit the name, UPI ID, minimum, and maximum deposit limits for each channel.</p>
                    <div class="channel-list" id="channelList">
                        <p style="color: #999;">Loading payment channels...</p>
                    </div>
                </div>
            </div>
            </div> 
    </div>

<script>
    // IMPORTANT: This HTML expects that firebaseConfig.js (included earlier) has already
    // initialized firebase (firebase.initializeApp(...)) so firebase.auth() and firebase.firestore() are available.

    const auth = firebase.auth();
    const db = firebase.firestore();

    // üõë CRITICAL: Define your Admin UIDs here. ONLY USERS with these UIDs will be granted access.
    // Replace these placeholder UIDs with the actual Firebase UIDs of your admin accounts.
    const ADMIN_UIDS = [
        '3aVUH6y9eVV6BB67IM9FWkHrN7q2', // ‚¨ÖÔ∏è Replace this with your actual Admin UID 1!
        'YOUR_ADMIN_UID_2'  // ‚¨ÖÔ∏è Replace this with your actual Admin UID 2!
        // Add all UIDs that should have admin access
    ];

    // --- 2. AUTHENTICATION (Firebase Auth Logic) ---
    
    const loginScreen = document.getElementById('loginScreen');
    const dashboardWrapper = document.getElementById('dashboardWrapper');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const welcomeMessage = document.getElementById('welcomeMessage');
    
    function showDashboard(userEmail) {
        loginScreen.style.display = 'none';
        dashboardWrapper.classList.add('visible');
        dashboardWrapper.style.display = 'flex'; 
        document.body.style.display = 'flex';
        welcomeMessage.textContent = `Welcome, ${userEmail}!`;
        loadAllData(); // Load data when the dashboard is shown
    }

    function showLoginScreen() {
        dashboardWrapper.classList.remove('visible');
        dashboardWrapper.style.display = 'none';
        loginScreen.style.display = 'flex';
        document.body.style.display = 'block'; 
    }

    // Check auth state on load
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Check if the logged-in user is an Admin
            if (ADMIN_UIDS.includes(user.uid)) {
                showDashboard(user.email);
            } else {
                console.error("Access Denied: User is not an authorized Admin.");
                alert("Access Denied: Your account is not authorized as an Admin.");
                auth.signOut(); // Force sign out non-admin
                showLoginScreen();
            }
        } else {
            showLoginScreen();
        }
    });


    loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        loginMessage.textContent = 'Logging in...';
        loginMessage.style.color = '#ffc700';

        // Firebase Authentication Sign-In
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // auth.onAuthStateChanged will handle the final Admin check and dashboard display.
                loginMessage.textContent = 'Verifying Admin credentials...';
                loginMessage.style.color = '#ffc700';
            })
            .catch((error) => {
                console.error("Login Error:", error);
                loginMessage.textContent = `Login Failed: ${error.message}`;
                loginMessage.style.color = 'red';
            });
    });

    window.logoutAdmin = function() {
        auth.signOut().then(() => {
            loginMessage.textContent = 'Logged out successfully.';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }).catch((error) => {
            console.error("Sign out error:", error);
        });
    }

    // --- 3. FIREBASE DATA MANAGEMENT ---

    const defaultUpiChannels = {
        sgpay: { id: 'mushkanbabu@ybl', name: 'SG Pay Services', min: 100, max: 50000 }, 
        crpay: { id: 'chandxrajni@ybl', name: 'CR Pay Agent', min: 100, max: 50000 },
        fastupi: { id: 'fastupi-rc@payment', name: 'Fast UPI', min: 300, max: 50000 },
        russiapay: { id: 'russiapay@upi', name: 'Russian Pay', min: 500, max: 100000 },
    };
    const sampleUsers = {
        'firebase-uid-1': { numericalUID: '226519', username: 'Chand Kishor', phone: '9876543210', status: 'active', balance: 167.00, password: 'userpass123', lastLogin: new Date().toISOString() },
        'firebase-uid-2': { numericalUID: '226520', username: 'Vishnu Kumar', phone: '8888777766', status: 'banned', balance: 45.00, password: 'bannedpwd456', lastLogin: new Date().toISOString() },
        'user_1': { numericalUID: '1', username: 'Generic User 1', phone: '1111111111', status: 'active', balance: 100.00, password: 'pass', lastLogin: new Date().toISOString() } 
    };
    const sampleAnnouncements = {
        'ANN001': { title: 'New Game Launch', content: 'Our new game is now live!', date: new Date().toISOString(), active: true },
        'ANN002': { title: 'Maintenance Notice', content: 'Scheduled maintenance tonight from 2 AM to 4 AM.', date: new Date().toISOString(), active: true }
    };

    async function initializeCollections() {
        const collections = [
            { name: 'users', data: sampleUsers },
            { name: 'announcements', data: sampleAnnouncements },
            { name: 'upi_channels', data: defaultUpiChannels } 
        ];

        for (const collectionInfo of collections) {
            const ref = db.collection(collectionInfo.name);
            try {
                const snapshot = await ref.limit(1).get();
                if (snapshot.empty) {
                    console.log(`Collection ${collectionInfo.name} is empty. Adding sample data.`);
                    for (const id in collectionInfo.data) {
                        await ref.doc(id).set(collectionInfo.data[id]);
                    }
                }
            } catch (error) {
                console.warn(`Warning: Could not check or initialize collection ${collectionInfo.name}. Firebase Error:`, error.message);
            }
        }
    }

    async function loadAllData() {
        await initializeCollections(); 
        
        // 1. Users & Dashboard Totals Listener
        db.collection('users').onSnapshot(snapshot => {
            let totalBalance = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                totalBalance += data.balance || 0;
            });
            document.getElementById('totalUsersCount').textContent = snapshot.size.toLocaleString();
            document.getElementById('totalUserBalance').textContent = `‚Çπ${totalBalance.toFixed(2).toLocaleString()}`;
        }, error => {
            console.error("Error fetching users. Check Firestore Rules!:", error);
            document.getElementById('totalUsersCount').textContent = 'Error!'; 
            document.getElementById('totalUserBalance').textContent = 'Error!';
        });

        // 2. Withdrawal Requests Listener (‚úÖ FINAL FIX: status is now 'processing' for pending withdrawals)
        db.collection('withdrawal_requests').where('status', '==', 'processing').onSnapshot(snapshot => {
            let pendingTotal = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                if(typeof data.amount === 'number' && data.amount > 0) {
                     pendingTotal += data.amount;
                }
            });
            document.getElementById('pendingWithdrawals').textContent = `‚Çπ${pendingTotal.toLocaleString()}`;
        }, error => {
            console.error("Error fetching pending withdrawals:", error);
            document.getElementById('pendingWithdrawals').textContent = 'Error!';
        });
        
        // 3. Deposit History Listener (Status 'Pending' is assumed correct)
        db.collection('deposit_requests').where('status', '==', 'Pending').onSnapshot(snapshot => {
            let pendingTotal = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                 if(typeof data.amount === 'number' && data.amount > 0) {
                    pendingTotal += data.amount;
                }
            });
            document.getElementById('pendingDepositsCount').textContent = `‚Çπ${pendingTotal.toLocaleString()}`;
        }, error => {
            console.error("Error fetching pending deposits:", error);
            document.getElementById('pendingDepositsCount').textContent = 'Error!';
        });
        
        // 4. Announcements Listener
        db.collection('announcements').orderBy('date', 'desc').onSnapshot(snapshot => {
            renderAnnouncementList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        }, error => {
            document.getElementById('announcementList').innerHTML = '<p style="color: red;">Failed to load announcements.</p>';
        });
        
        // 5. Payment Channels Listener
        db.collection('upi_channels').onSnapshot(snapshot => {
            renderChannelList(snapshot.docs.map(doc => ({ 
                docId: doc.id, 
                vpa: doc.data().id, 
                name: doc.data().name,
                min: doc.data().min,
                max: doc.data().max
            })));
        }, error => {
            document.getElementById('channelList').innerHTML = '<p style="color: red;">Failed to load payment channels.</p>';
        });
    }

    // --- 4. RENDER FUNCTIONS ---
    
    function renderAnnouncementList(announcements) {
        const listDiv = document.getElementById('announcementList');
        listDiv.innerHTML = '';
        announcements.forEach(ann => {
            const row = `
                <div class="announcement-card">
                    <h4>${ann.title}</h4>
                    <small>Date: ${new Date(ann.date).toLocaleDateString()} | Active: ${ann.active ? 'Yes' : 'No'}</small>
                    <p>${ann.content}</p>
                    <button class="action-btn btn-ban" style="background-color: #f33;" onclick="deleteAnnouncement('${ann.id}')">Delete</button>
                </div>
            `;
            listDiv.innerHTML += row;
        });
        if (announcements.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No active announcements.</p>';
        }
    }
    
    function renderChannelList(channels) {
        const listDiv = document.getElementById('channelList');
        listDiv.innerHTML = '';
        channels.forEach(channel => {
            const min = channel.min || 100;
            const max = channel.max || 50000;
            
            const safeName = channel.name ? channel.name.replace(/'/g, "\\'") : '';

            const row = `
                <div class="channel-card">
                    <h4>${channel.name} (Key: ${channel.docId})</h4>
                    <p><strong>UPI ID (Receiver VPA):</strong> <span>${channel.vpa}</span></p>
                    <p><strong>Min Deposit Amount:</strong> ‚Çπ${min.toLocaleString()}</p>
                    <p><strong>Max Deposit Amount:</strong> ‚Çπ${max.toLocaleString()}</p>
                    
                    <button onclick="editChannel('${channel.docId}', '${safeName}', '${channel.vpa}', ${min}, ${max})">Edit Details</button>
                </div>
            `;
            listDiv.innerHTML += row;
        });
        if (channels.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">No payment channels configured.</p>';
        }
    }

    // --- 5. ACTION FUNCTIONS ---
    
    window.editChannel = async function(docId, currentName, currentVpa, currentMin, currentMax) {
        const newName = prompt(`Enter new Channel Display Name for key '${docId}' (Current: ${currentName}):`, currentName);
        if (!newName || newName.trim() === "") return;
        
        const newVpa = prompt(`Enter new UPI ID (VPA) for channel key '${docId}' (Current: ${currentVpa}):`, currentVpa);
        if (!newVpa || newVpa.trim() === "") return;

        const newMinStr = prompt(`Enter new Minimum Deposit (‚Çπ) for channel key '${docId}' (Current: ${currentMin}):`, currentMin);
        if (newMinStr === null) return;
        
        const newMaxStr = prompt(`Enter new Maximum Deposit (‚Çπ) for channel key '${docId}' (Current: ${currentMax}):`, currentMax);
        if (newMaxStr === null) return;


        const newMin = parseFloat(newMinStr);
        const newMax = parseFloat(newMaxStr);
        
        if (isNaN(newMin) || newMin < 0 || isNaN(newMax) || newMax < newMin) {
            alert("Invalid amounts entered. Ensure Min is a number >= 0 and Max is a number >= Min.");
            return;
        }

        if (confirm(`Confirm changes for channel key ${docId}:\nName: ${newName}\nUPI ID: ${newVpa}\nMin: ‚Çπ${newMin.toFixed(2)}\nMax: ‚Çπ${newMax.toFixed(2)}`)) {
            try {
                await db.collection('upi_channels').doc(docId).update({
                    name: newName,
                    id: newVpa,
                    min: newMin,
                    max: newMax 
                });
                alert("Payment channel updated successfully!");
            } catch (error) {
                console.error("Error updating channel:", error);
                alert("Failed to update payment channel: " + error.message);
            }
        }
    }

    window.addAnnouncement = async function() {
        const title = prompt("Enter Announcement Title:");
        if (!title) return;
        const content = prompt("Enter Announcement Content:");
        if (!content) return;

        try {
            await db.collection('announcements').add({
                title: title,
                content: content,
                date: new Date().toISOString(),
                active: true
            });
            alert("Announcement created successfully!");
        } catch (error) {
            console.error("Error creating announcement:", error);
            alert("Failed to create announcement.");
        }
    }

    window.deleteAnnouncement = async function(id) {
        if (confirm("Are you sure you want to delete this announcement?")) {
            try {
                await db.collection('announcements').doc(id).delete();
                alert("Announcement deleted.");
            } catch (error) {
                console.error("Error deleting announcement:", error);
                alert("Failed to delete announcement.");
            }
        }
    }


    // --- 6. EVENT LISTENERS ---

    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));

            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

</script>
</body>
</html>
