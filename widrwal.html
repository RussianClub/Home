<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian Club - Withdraw</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
    <style>
        /* Global & Reset Styles (Matching Theme) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; 
            color: #f0f0f0; 
        }
        .container {
            max-width: 450px; 
            margin: 0 auto;
            padding: 0;
            background-color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Variables for Theme Consistency */
        :root {
            --header-height: 55px; 
            --accent-gold: #ffc700;
            --dark-bg-card: #252525;
            --pink-red-gradient: linear-gradient(90deg, #e50074, #ff0099);
            --min-withdraw: 110;
            --max-withdraw: 50000;
        }
        
        /* ------------------- GLASSMORPHIC STICKY HEADER ------------------- */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 450px; 
            box-sizing: border-box; 

            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);

            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between; 
            font-size: 1.2em;
            font-weight: 800;
            z-index: 1000;
            border-radius: 0 0 12px 12px;

            height: var(--header-height); 
            padding: 0 15px; 
        }

        .icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px; 
            text-align: left;
            padding: 0;
        }

        .header-title {
            font-size: 1em;
            font-weight: 700;
            text-align: center;
            flex-grow: 1;
        }

        .header-spacer { 
            width: 30px; 
        }
        
        /* ------------------- MAIN CONTENT AREA ------------------- */
        .main-content {
            padding-top: var(--header-height);
            max-width: 450px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box; 
            padding-bottom: 30px;
        }
        
        /* ------------------- BALANCE CARD ------------------- */
        .balance-card {
            background: linear-gradient(135deg, #333333, #1a1a1a);
            border-radius: 15px;
            margin: 15px 15px 20px 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -20px;
            left: -20px;
            right: -20px;
            height: 100px;
            background: linear-gradient(100deg, rgba(255, 199, 0, 0.3), rgba(255, 170, 0, 0.1));
            border-radius: 50% 50% 0 0;
            opacity: 0.2;
            transform: rotate(5deg);
        }

        .balance-info {
            position: relative;
            z-index: 10;
        }

        .balance-label {
            font-size: 0.9em;
            color: #ccc;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .balance-value {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--accent-gold);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px; 
        }
        
        /* Name position adjusted to be lower */
        #accountHolderNameDisplay {
            justify-content: flex-start; 
            margin-top: 25px; 
            font-weight: bold; 
            font-size: 0.9em; 
            color: #ccc;
            align-self: flex-start;
        }


        .refresh-icon {
            color: #999;
            cursor: pointer;
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        .refresh-icon:active {
            transform: rotate(360deg);
        }

        .card-details {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        /* Adjusted the icon position to be slightly higher/more balanced */
        .balance-card .card-details:last-child {
            margin-top: 0; 
            position: absolute;
            bottom: 20px;
            right: 20px;
        }


        .card-icon {
            font-size: 2em;
            color: rgba(255, 199, 0, 0.8);
            margin-right: 0; 
        }

        /* ------------------- PAYMENT METHOD SECTION ------------------- */
        .payment-section {
            background-color: var(--dark-bg-card);
            border-radius: 15px;
            margin: 0 15px 20px 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        
        .method-options {
            display: flex;
            justify-content: space-around; 
            gap: 10px;
            margin-bottom: 15px;
        }

        .method-btn {
            flex: 1; 
            padding: 10px 5px;
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 150px; 
        }
        
        .method-btn.active {
            background: #ffc700;
            color: #1a1a1a;
            border-color: #ffc700;
            box-shadow: 0 0 8px rgba(255, 199, 0, 0.5);
            transform: translateY(-2px);
        }

        /* Method detail card */
        .method-detail-card {
            background-color: #333;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .method-detail-card:hover {
            background-color: #444;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            font-size: 0.9em;
        }
        .card-info span {
            color: #f0f0f0;
            font-weight: bold;
        }
        .card-info small {
            color: #aaa;
            font-size: 0.75em;
        }
        /* Style for "Add Bank Card" state */
        .card-info .placeholder-text {
            color: #ff0099; 
            font-weight: bold;
            font-size: 1em;
        }
        
        .method-detail-card > i {
            color: #aaa;
        }

        /* ------------------- AMOUNT INPUT SECTION ------------------- */
        .amount-input-section {
            background-color: var(--dark-bg-card);
            border-radius: 15px;
            margin: 0 15px 20px 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }
        .amount-title {
            color: var(--accent-gold);
            font-weight: bold;
            margin-bottom: 10px;
            text-align: left; 
            font-size: 1.1em;
        }

        .input-wrapper {
            background-color: #333;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border: 1px solid #444;
            margin-bottom: 15px;
        }
        .input-wrapper span {
            font-size: 1.2em;
            color: #ccc;
            margin-right: 10px;
        }
        #withdrawalAmount {
            flex-grow: 1;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.1em;
            outline: none;
            padding: 5px 0;
            text-align: left; 
        }
        #withdrawalAmount::placeholder {
            color: #777;
            text-align: left; 
        }

        .balance-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #aaa;
            padding: 5px 0;
        }
        .balance-details .all-btn {
            color: var(--accent-gold);
            font-weight: bold;
            cursor: pointer;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255, 199, 0, 0.1);
        }

        .withdraw-button {
            width: 100%;
            padding: 15px 20px;
            background: var(--pink-red-gradient);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1em;
            transition: opacity 0.3s ease, transform 0.2s ease;
            box-shadow: 0 6px 15px rgba(229, 0, 116, 0.4); 
            margin-top: 15px;
        }

        .withdraw-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .withdraw-button:active {
            transform: scale(0.98);
        }

        /* ------------------- RULES SECTION ------------------- */
        .rules-section {
            padding: 0 15px;
            margin-bottom: 20px;
        }
        .rules-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .rules-section li {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }
        .rules-section li i {
            color: var(--accent-gold);
            margin-right: 8px;
            margin-top: 4px;
            font-size: 0.7em;
        }
        .rules-section li strong {
            color: var(--accent-gold);
        }

        /* ------------------- WITHDRAWAL HISTORY (New Card-based Style) ------------------- */

        /* Header is now separate from the list container */
        .history-header-box {
            margin: 0 15px 15px 15px;
            padding: 0 0 10px 0;
        }
        .history-header {
            font-size: 1.1em;
            color: var(--accent-gold);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between; 
        }
        .history-header i {
            margin-right: 8px;
            color: #e50074;
        }
        
        .history-list {
            list-style: none;
            padding: 0;
            margin: 0 15px; /* Margin to align with other content */
        }

        .history-item-card {
            background-color: var(--dark-bg-card);
            border-radius: 12px;
            margin-bottom: 12px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            font-size: 0.9em;
        }

        .history-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Amount is yellow/gold */
        .history-amount {
            font-weight: bold;
            color: var(--accent-gold); 
            font-size: 1.2em;
        }

        /* Status is colored by status class */
        .history-status-right {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Grid for details (Left/Right alignment inside the card) */
        .history-details-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr; /* Right side gets a bit more space */
            gap: 5px 10px;
            color: #aaa;
            padding-top: 5px; /* slight padding above the grid */
            border-top: 1px dashed #333;
        }

        .grid-label {
            color: #ccc;
            font-weight: 500;
        }

        /* Value color is now WHITE for Time and Order No. */
        .grid-value {
            text-align: right;
            color: #fff; /* Changed from yellow/gold to white */
            font-weight: normal; /* Made it less bold */
            word-break: break-all;
        }
        
        /* Making Type value a bit more prominent and yellow/gold */
        .grid-label.type + .grid-value {
            font-weight: bold;
            color: var(--accent-gold); 
        }


        /* Status Color Styles */
        .status-success, .status-complete { 
            color: #5cb85c; /* Green for Success/Complete */
        }
        .status-rejected {
            color: #d9534f;
        }
        .status-processing {
            color: var(--accent-gold); /* Gold for Processing */
        }

        .no-history {
            text-align: center;
            color: #777;
            padding: 20px 0;
            font-size: 0.9em;
            margin: 0 15px;
        }
        
        /* ------------------- MODAL/POPUP STYLES ------------------- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 3000; /* Standard Modal Z-Index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--dark-bg-card);
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #333;
            width: 90%; 
            max-width: 350px; 
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-header h3 {
            margin: 0;
            color: var(--accent-gold);
            font-size: 1.2em;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.3s;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #ccc;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: var(--accent-gold);
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: var(--pink-red-gradient);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .save-btn:hover {
            opacity: 0.9;
        }

        .bank-form, .upi-form {
            display: none; 
        }

        /* ------------------- TOAST NOTIFICATION STYLES (UPDATED) ------------------- */
        #toast-container {
            position: fixed; 
            top: 65px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 5000 !important; /* IMPORTANT: Set higher Z-Index to show above Modals (z-index: 3000) */
            width: 90%; 
            max-width: 400px;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="sticky-header">
            <button class="icon-btn" onclick="goBack()"><i class="fa fa-arrow-left"></i></button>
            <div class="header-title">Withdraw</div>
            <div class="header-spacer"></div> 
        </div>

        <div class="main-content">

            <div class="balance-card">
                <div class="balance-info">
                    <div class="balance-label">
                        <span>Available balance</span>
                        <i class="fa fa-sync refresh-icon" onclick="fetchBalance()"></i>
                    </div>
                    <div class="balance-value">₹<span id="availableBalance">0.00</span></div>
                </div>
                <div id="accountHolderNameDisplay" class="card-details" style="justify-content: flex-start; margin-top: 25px; font-weight: bold; font-size: 0.9em; color: #ccc; align-self: flex-start;">ACCOUNT HOLDER NAME</div>
                
                <div class="card-details">
                    <i class="fa fa-credit-card card-icon"></i>
                </div>
            </div>

            <div class="payment-section">
                
                <div class="method-options">
                    <div class="method-btn active" id="btn-bankcard" data-method="bankcard" onclick="selectMethod('bankcard')">
                        <i class="fa fa-credit-card"></i> BANK CARD
                    </div>
                    <div class="method-btn" id="btn-upi" data-method="upi" onclick="selectMethod('upi')">
                        <i class="fa fa-mobile"></i> UPI
                    </div>
                </div>
                
                <div class="method-detail-card" id="selectedMethodDetails" onclick="editMethodDetails()">
                    <div class="card-info">
                        <span id="methodNameDisplay" class="placeholder-text">Loading...</span>
                        <small id="methodIdDisplay"></small>
                    </div>
                    <i class="fa fa-angle-right"></i>
                </div>
            </div>

            <div class="amount-input-section">
                <div class="amount-title">Please enter the amount</div> 
                <div class="input-wrapper">
                    <span>₹</span>
                    <input type="number" id="withdrawalAmount" placeholder="Enter Amount" min="110" max="50000" oninput="updateWithdrawalDetails()" style="text-align: left;">
                </div>
                
                <div class="balance-details">
                    <div>
                        Withdrawal available balance ₹<span id="withdrawableBalance">0.00</span>
                    </div>
                    <div class="all-btn" onclick="setAllAmount()">All</div>
                </div>

                <button class="withdraw-button" onclick="processWithdrawal()" id="withdrawBtn">
                    Withdraw
                </button>
            </div>

            <div class="rules-section">
                <ul>
                    <li><i class="fa fa-star"></i> Need to bet ₹<strong id="confirmAmount">0.39</strong> to be able to withdraw</li>
                    <li><i class="fa fa-star"></i> Withdraw time <strong>00:00-23:59</strong></li>
                    <li><i class="fa fa-star"></i> Inday Remaining Withdrawal Times <strong id="remainingWithdrawalsDisplay">3</strong></li> 
                    <li><i class="fa fa-star"></i> Withdrawal amount range <strong>₹110.00-₹50,000.00</strong></li>
                    <li><i class="fa fa-star"></i> Please confirm your beneficial account information before withdrawing. If your information is incorrect, our company will not be liable for the amount of loss.</li>
                    <li><i class="fa fa-star"></i> If your beneficial information is incorrect, please contact customer service</li>
                </ul>
            </div>
            
            <div class="history-header-box">
                <div class="history-header">
                    <div class="history-header-left">
                        <i class="fa fa-history"></i> Withdrawal history
                    </div>
                </div>
            </div>

            <ul class="history-list" id="withdrawalHistoryList">
                </ul>
            <div id="noHistoryMessage" class="no-history" style="display: none;">No withdrawal history found.</div>

        </div>
        
    </div>

    <div id="addDetailsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add Payment Details</h3>
          <span class="close-btn" onclick="closeAddDetailsModal()">&times;</span>
        </div>
        
        <form id="bankForm" class="bank-form" onsubmit="event.preventDefault(); savePaymentDetails('bankcard');">
          <div class="form-group">
            <label for="bankHolderName">Account Holder Name</label>
            <input type="text" id="bankHolderName" placeholder="Enter Full Name" required>
          </div>
          <div class="form-group">
            <label for="bankAccountNumber">Bank Account Number</label>
            <input type="number" id="bankAccountNumber" placeholder="Enter Account Number" required>
          </div>
          <div class="form-group">
            <label for="bankIFSC">IFSC Code</label>
            <input type="text" id="bankIFSC" placeholder="Enter IFSC Code" style="text-transform: uppercase;" required minlength="11" maxlength="11">
          </div>
          <div class="form-group">
            <label for="bankName">Bank Name</label>
            <input type="text" id="bankName" placeholder="Enter Bank Name">
          </div>
          <div class="form-group">
            <label for="bankEmail">Email Address (Optional)</label>
            <input type="email" id="bankEmail" placeholder="Enter Email">
          </div>
          <button class="save-btn" type="submit">Save Bank Card</button>
        </form>
        
        <form id="upiForm" class="upi-form" onsubmit="event.preventDefault(); savePaymentDetails('upi');">
          <div class="form-group">
            <label for="upiHolderName">Account Holder Name</label>
            <input type="text" id="upiHolderName" placeholder="Enter Full Name" required>
          </div>
          <div class="form-group">
            <label for="upiVPA">UPI ID / VPA</label>
            <input type="text" id="upiVPA" placeholder="Example: user@bankname" required>
          </div>
           <div class="form-group">
            <label for="upiEmail">Email Address (Optional)</label>
            <input type="email" id="upiEmail" placeholder="Enter Email">
          </div>
          <button class="save-btn" type="submit">Save UPI ID</button>
        </form>
        
      </div>
    </div>
    
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="justify-content: center;">
                <h3 id="passwordModalTitle">Enter Login Password</h3>
            </div>
            
            <div class="form-group">
                <label for="withdrawalPassword">Password</label>
                <input type="password" id="withdrawalPassword" placeholder="Enter your login password" required>
            </div>
            
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button class="save-btn" style="background: #555; box-shadow: none;" onclick="closePasswordModal()">Cancel</button>
                <button class="save-btn" id="passwordConfirmBtn" onclick="confirmWithdrawalWithPassword()">Confirm</button>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <div id="toast-container"></div> 

    <script type="module">
        // --- STEP 1: ADD SHA-256 HASHING UTILITY FUNCTION ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }
        window.sha256 = sha256; 
        
        // --- CONSTANTS ---
        const MIN_WITHDRAW = 110;
        const MAX_WITHDRAW = 50000;
        const MAX_DAILY_WITHDRAWALS = 3; 
        
        // **IMPORTANT:** Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDlEY_2bDv25T5GTCzTEk7sQIZrAxh5irc", 
            authDomain: "russian-club.firebaseapp.com",
            projectId: "russian-club",
            storageBucket: "russian-club.firebasestorage.app",
            messagingSenderId: "659659196153",
            appId: "1:659659196153:web:d6aaa4650fcff3d5fa0428",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- DOM Elements ---
        const availableBalanceEl = document.getElementById('availableBalance');
        const withdrawableBalanceEl = document.getElementById('withdrawableBalance');
        const withdrawalAmountInput = document.getElementById('withdrawalAmount');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const historyListEl = document.getElementById('withdrawalHistoryList');
        const noHistoryMessageEl = document.getElementById('noHistoryMessage');
        const confirmAmountEl = document.getElementById('confirmAmount');
        const methodNameDisplay = document.getElementById('methodNameDisplay');
        const methodIdDisplay = document.getElementById('methodIdDisplay');
        const accountHolderNameDisplay = document.getElementById('accountHolderNameDisplay'); 
        
        // **NEW ELEMENT:** Remaining Withdrawals Display
        const remainingWithdrawalsDisplayEl = document.getElementById('remainingWithdrawalsDisplay'); 
        
        // Modal Elements
        const addDetailsModal = document.getElementById('addDetailsModal');
        const passwordModal = document.getElementById('passwordModal'); 
        const modalTitle = document.getElementById('modalTitle');
        const bankForm = document.getElementById('bankForm');
        const upiForm = document.getElementById('upiForm');
        
        let currentUID = null;
        let userBalance = 0;
        let selectedMethod = 'bankcard'; 

        // --- HELPER FUNCTIONS ---

        function getLoggedInUserUID() {
            const uid = localStorage.getItem('loggedInUserUID');
            return uid;
        }

        function formatCurrency(amount) {
            return Number(amount).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function goBack() {
            history.back();
        }
        window.goBack = goBack; 

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            toast.style.padding = '12px 20px';
            toast.style.marginBottom = '10px';
            toast.style.borderRadius = '8px';
            toast.style.fontSize = '0.95em';
            toast.style.fontWeight = '600';
            toast.style.color = 'white';
            toast.style.textAlign = 'center';
            toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.4)';
            toast.style.background = type === 'success' ? '#28a745' : '#dc3545';
            
            toast.textContent = message;
            container.prepend(toast); 
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 400); 
            }, 4000); 
        }

        // --- PASSWORD MODAL FUNCTIONS ---
        function openPasswordModal() {
            passwordModal.style.display = 'block';
            document.getElementById('withdrawalPassword').value = ''; 
        }

        function closePasswordModal() {
            passwordModal.style.display = 'none';
        }
        window.closePasswordModal = closePasswordModal;

        async function confirmWithdrawalWithPassword() {
            const passwordInput = document.getElementById('withdrawalPassword');
            const enteredPassword = passwordInput.value.trim();
            
            if (!enteredPassword) {
                showToast('Please enter your login password.', 'error');
                return;
            }
            
            const enteredPasswordHash = await sha256(enteredPassword);

            let storedHash = null;
            try {
                const userDoc = await db.collection('users').doc(currentUID).get();
                if (userDoc.exists) {
                    storedHash = userDoc.data().hashedPassword || userDoc.data().password; 
                }
            } catch (error) {
                console.error("Error fetching user data for password check:", error);
                showToast('Failed to verify user. Please try again.', 'error');
                return;
            }
            
            let isPasswordCorrect = false;

            if (storedHash && enteredPasswordHash === storedHash) {
                isPasswordCorrect = true;
            }
            
            if (!isPasswordCorrect) {
                showToast('Incorrect Login Password.', 'error');
                passwordInput.value = ''; // Clear input on failure
                return;
            }
            
            closePasswordModal();
            await finalizeWithdrawal(); 
        }
        window.confirmWithdrawalWithPassword = confirmWithdrawalWithPassword;
        // --- END PASSWORD MODAL FUNCTIONS ---

        // --- PAYMENT DETAILS MODAL FUNCTIONS (UPDATED WITH DUPLICATE CHECK) ---

        // **NEW:** Function to check if account/UPI ID is already in use by another user
        async function checkDuplicateDetails(method, identifierValue) {
            if (!identifierValue) return false;
            
            // Determine the field name to query based on the method
            const fieldName = (method === 'bankcard') ? 'bankcard.account_number' : 'upi.upi_id';
            
            try {
                // Query firestore for any document containing this identifierValue
                const querySnapshot = await db.collection('user_payment_details')
                    .where(fieldName, '==', identifierValue)
                    .limit(1)
                    .get();
                    
                if (querySnapshot.empty) {
                    return false; // Not found anywhere
                }
                
                // If found, check if the found document belongs to the current user (doc.id == currentUID)
                const doc = querySnapshot.docs[0];
                
                // If the document ID (UID) is NOT the current UID, it means another user is using it.
                return doc.id !== currentUID; 
                
            } catch (error) {
                console.error("Error checking duplicate payment details. Ensure index is created:", error);
                // Treat error as safe (no duplicate check) in case of unexpected firestore error.
                return false; 
            }
        }

        function openAddDetailsModal(method) {
            if (!currentUID) {
                showToast('Please log in to add details.', 'error');
                return;
            }
            
            if (method === 'bankcard') {
                modalTitle.textContent = 'Add Bank Card Details';
                bankForm.style.display = 'block';
                upiForm.style.display = 'none';
            } else if (method === 'upi') {
                modalTitle.textContent = 'Add UPI ID';
                upiForm.style.display = 'block';
                bankForm.style.display = 'none';
            }
            
            bankForm.reset();
            upiForm.reset();
            addDetailsModal.style.display = 'block';
            
            // Fetch existing details to pre-fill the form
            fetchPaymentDetails(method).then(details => {
                if (details) {
                    if (method === 'bankcard') {
                        document.getElementById('bankHolderName').value = details.account_holder || '';
                        document.getElementById('bankAccountNumber').value = details.account_number || '';
                        document.getElementById('bankIFSC').value = details.ifsc || '';
                        document.getElementById('bankName').value = details.bank_name || '';
                        document.getElementById('bankEmail').value = details.email || '';
                    } else if (method === 'upi') {
                        document.getElementById('upiHolderName').value = details.account_holder || '';
                        document.getElementById('upiVPA').value = details.upi_id || '';
                        document.getElementById('upiEmail').value = details.email || '';
                    }
                }
            });
        }
        window.openAddDetailsModal = openAddDetailsModal; 

        function closeAddDetailsModal() {
            addDetailsModal.style.display = 'none';
        }
        window.closeAddDetailsModal = closeAddDetailsModal; 

        async function savePaymentDetails(method) {
            let details = {};
            let identifier = '';
            let identifierValue = '';

            if (method === 'bankcard') {
                details.account_holder = document.getElementById('bankHolderName').value.trim();
                details.account_number = document.getElementById('bankAccountNumber').value.trim();
                details.ifsc = document.getElementById('bankIFSC').value.trim().toUpperCase();
                details.bank_name = document.getElementById('bankName').value.trim();
                details.email = document.getElementById('bankEmail').value.trim();
                
                identifier = 'Account Number';
                identifierValue = details.account_number;

                if (!details.account_holder || details.account_number.length < 9 || details.ifsc.length !== 11) {
                    showToast('Please fill valid Name, Account Number (min 9 digits), and 11-digit IFSC Code.', 'error');
                    return;
                }

            } else if (method === 'upi') {
                details.account_holder = document.getElementById('upiHolderName').value.trim();
                details.upi_id = document.getElementById('upiVPA').value.trim();
                details.email = document.getElementById('upiEmail').value.trim();
                
                identifier = 'UPI ID';
                identifierValue = details.upi_id;
                
                if (!details.account_holder || !details.upi_id || !details.upi_id.includes('@')) {
                    showToast('Please fill valid Name and UPI ID (must contain @).', 'error');
                    return;
                }
            }
            
            // --- STEP 1: CHECK FOR DUPLICATES ---
            const isDuplicate = await checkDuplicateDetails(method, identifierValue);
            
            if (isDuplicate) {
                showToast(`This ${identifier} is already registered with another user. Please use your own account/ID.`, 'error');
                return; 
            }
            // ------------------------------------

            details.saved_at = firebase.firestore.FieldValue.serverTimestamp();

            try {
                const updateData = {};
                updateData[method] = details; 

                await db.collection('user_payment_details').doc(currentUID).set(updateData, { merge: true });

                showToast(`${method.toUpperCase()} details saved successfully!`, 'success');
                closeAddDetailsModal();
                
                selectMethod(selectedMethod); // Refresh the display card

            } catch (error) {
                console.error("Error saving payment details:", error);
                showToast('Failed to save details. Please try again.', 'error');
            }
        }
        window.savePaymentDetails = savePaymentDetails; 

        // --- CORE LOGIC ---

        function isDetailsPresent() {
            // Checks if the method card currently displays a placeholder
            return !methodNameDisplay.classList.contains('placeholder-text');
        }

        function editMethodDetails() {
            // Disable editing if details are already saved
            if (isDetailsPresent()) {
                showToast(`Details for ${selectedMethod.toUpperCase()} are saved. Please contact customer service to edit.`, 'error');
                return; 
            }
            openAddDetailsModal(selectedMethod);
        }
        window.editMethodDetails = editMethodDetails;

        async function fetchPaymentDetails(method) {
            if (!currentUID) return null;

            try {
                const docRef = db.collection('user_payment_details').doc(currentUID);
                const doc = await docRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    return data[method] || null;
                }
                return null;

            } catch (error) {
                console.error("Error fetching payment details:", error);
                return null;
            }
        }

        async function updateMethodDisplay(method) {
            const details = await fetchPaymentDetails(method);

            // Reset classes
            methodNameDisplay.classList.remove('placeholder-text');
            methodIdDisplay.textContent = '';
            
            // Logic for Balance Card Name Display
            let holderName = 'ACCOUNT HOLDER NAME';
            
            const bankDetailsForName = await fetchPaymentDetails('bankcard');
            
            if (bankDetailsForName && bankDetailsForName.account_holder) {
                // Preference: Show Bank Card holder name if available
                holderName = bankDetailsForName.account_holder.toUpperCase();
            } else if (method === 'upi' && details && details.account_holder) {
                // Fallback: Show current UPI holder name if bank is missing
                holderName = details.account_holder.toUpperCase();
            } 
            
            accountHolderNameDisplay.textContent = holderName; 
            
            if (details) {
                if (method === 'bankcard') {
                    const name = details.bank_name || 'Bank Card';
                    const acc = details.account_number || '000000000000';
                    
                    // FIXED MASKING: Show first 4 and last 4, middle ****
                    const length = acc.length;
                    let maskedAcc = acc.substring(0, 4) + '****' + acc.substring(length - 4);
                    
                    methodNameDisplay.textContent = name;
                    methodIdDisplay.textContent = maskedAcc;
                } else if (method === 'upi') {
                    const upiId = details.upi_id || 'user@bank';
                    
                    // FIXED MASKING: Show first few chars and domain, middle ****
                    const atIndex = upiId.indexOf('@');
                    let maskedUpi = upiId;
                    if (atIndex > 0) {
                        maskedUpi = upiId.substring(0, 3) + '****' + upiId.substring(atIndex);
                    } else {
                         maskedUpi = upiId.substring(0, 3) + '****';
                    }
                    
                    methodNameDisplay.textContent = details.account_holder || 'UPI Account';
                    methodIdDisplay.textContent = maskedUpi;
                }
            } else {
                // No details found - show placeholder for adding details
                methodNameDisplay.classList.add('placeholder-text');
                if (method === 'bankcard') {
                    methodNameDisplay.textContent = 'Add Bank Card';
                    methodIdDisplay.textContent = 'Click to add account details';
                } else if (method === 'upi') {
                    methodNameDisplay.textContent = 'Add UPI ID';
                    methodIdDisplay.textContent = 'Click to add VPA details';
                }
            }
        }
        
        async function selectMethod(method) {
            selectedMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`btn-${method}`).classList.add('active');

            await updateMethodDisplay(method);
        }
        window.selectMethod = selectMethod;

        // **UPDATED:** Now fetches 'confirm_needed' and calls 'calculateRemainingWithdrawals'.
        async function fetchBalance() {
            if (!currentUID) return;

            const userRef = db.collection('users').doc(currentUID);
            try {
                const doc = await userRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    userBalance = data.balance || 0; 
                    
                    // --- WORKING: Need to bet amount ---
                    const confirmNeeded = data.confirm_needed || 0.39; 
                    
                    availableBalanceEl.textContent = formatCurrency(userBalance);
                    withdrawableBalanceEl.textContent = formatCurrency(userBalance); 
                    confirmAmountEl.textContent = formatCurrency(confirmNeeded); // <--- Update 'Need to bet' amount
                    
                    updateWithdrawalDetails(); 
                    
                    // --- WORKING: Remaining Withdrawals ---
                    await calculateRemainingWithdrawals(currentUID);
                    
                } else {
                    availableBalanceEl.textContent = '0.00';
                    withdrawableBalanceEl.textContent = '0.00';
                    confirmAmountEl.textContent = '0.00';
                }
            } catch (error) {
                console.error("Error fetching balance:", error);
                showToast('Failed to fetch balance. Try refreshing.', 'error');
            }
        }
        window.fetchBalance = fetchBalance; 
        
        // **NEW FUNCTION:** Calculates and displays remaining daily withdrawals
        async function calculateRemainingWithdrawals(uid) {
            if (!uid) return;
            
            try {
                // Get today's date in YYYY-MM-DD format (used in 'date_string' field)
                const today = new Date().toISOString().slice(0, 10); 
                
                // This query REQUIRES A COMPOSITE INDEX on (uid ASCENDING, date_string ASCENDING)
                const todayRequests = await db.collection('withdrawal_requests')
                    .where('uid', '==', uid)
                    .where('date_string', '==', today) 
                    .get();

                const requestsCount = todayRequests.docs.length;
                const remaining = MAX_DAILY_WITHDRAWALS - requestsCount;
                
                // Ensure the remaining count is never negative
                const displayCount = Math.max(0, remaining);
                
                remainingWithdrawalsDisplayEl.textContent = displayCount;

                if (displayCount === 0) {
                     // Removed showToast: 'Daily withdrawal limit of 3 reached.'
                }

            } catch (error) {
                console.error("Error calculating remaining withdrawals. Ensure 'uid' and 'date_string' index exists.", error);
                // Fallback to static max number if error occurs
                remainingWithdrawalsDisplayEl.textContent = MAX_DAILY_WITHDRAWALS;
            }
        }


        function updateWithdrawalDetails() {
            const amount = parseFloat(withdrawalAmountInput.value);
            
            if (amount < MIN_WITHDRAW || amount > MAX_WITHDRAW || amount > userBalance) {
                withdrawBtn.disabled = true;
            } else {
                withdrawBtn.disabled = false;
            }
        }
        window.updateWithdrawalDetails = updateWithdrawalDetails;

        function setAllAmount() {
             const maxWithdraw = Math.min(userBalance, MAX_WITHDRAW);
             withdrawalAmountInput.value = maxWithdraw.toFixed(2);
             updateWithdrawalDetails();
        }
        window.setAllAmount = setAllAmount;

        // ENTRY POINT: Handles checks and shows password modal
        async function processWithdrawal() {
            const amount = parseFloat(withdrawalAmountInput.value);
            const details = await fetchPaymentDetails(selectedMethod);

            // 1. Payment Detail Check
            if (!details) {
                showToast(`Please add your ${selectedMethod.toUpperCase()} details before withdrawing.`, 'error');
                openAddDetailsModal(selectedMethod);
                return;
            }
            // 2. Withdrawal Limits Check
            if (amount < MIN_WITHDRAW || amount > MAX_WITHDRAW) {
                showToast(`Withdrawal must be between ₹${MIN_WITHDRAW} and ₹${MAX_WITHDRAW}.`, 'error');
                return;
            }
            if (amount > userBalance) {
                 showToast('Insufficient balance.', 'error');
                return;
            }
            
            // 3. Daily Withdrawal Limit Check (pre-check)
            const today = new Date().toISOString().slice(0, 10); 
            const todayRequests = await db.collection('withdrawal_requests')
                .where('uid', '==', currentUID)
                .where('date_string', '==', today) 
                .get();
            
            if (todayRequests.docs.length >= MAX_DAILY_WITHDRAWALS) {
                showToast(`Daily withdrawal limit of ${MAX_DAILY_WITHDRAWALS} reached.`, 'error');
                return;
            }

            // 4. Prompt for password
            openPasswordModal();
        }
        window.processWithdrawal = processWithdrawal;
        
        // CORE TRANSACTION: Runs only after password is confirmed
        async function finalizeWithdrawal() {
            const amount = parseFloat(withdrawalAmountInput.value);
            const details = await fetchPaymentDetails(selectedMethod);
            
            if (amount < MIN_WITHDRAW || amount > MAX_WITHDRAW || amount > userBalance || !details) {
                showToast('Withdrawal data invalid. Please try again.', 'error');
                return;
            }

            withdrawBtn.disabled = true;
            withdrawBtn.textContent = 'Processing...';

            try {
                const withdrawalRef = db.collection('withdrawal_requests').doc(); 
                const orderNumber = 'WD' + Date.now().toString();
                const today = new Date().toISOString().slice(0, 10); 

                // Transaction to update balance and create request
                await db.runTransaction(async (transaction) => {
                    const userRef = db.collection('users').doc(currentUID);
                    const userDoc = await transaction.get(userRef);

                    if (!userDoc.exists) {
                         throw new Error("User data missing.");
                    }
                    
                    const currentBalance = userDoc.data().balance || 0;
                    if (currentBalance < amount) {
                        throw new Error("Insufficient funds for withdrawal.");
                    }

                    // Final Daily Withdrawal Limit Check (inside transaction)
                    const todayRequests = await db.collection('withdrawal_requests')
                        .where('uid', '==', currentUID)
                        .where('date_string', '==', today) 
                        .get();

                    if (todayRequests.docs.length >= MAX_DAILY_WITHDRAWALS) {
                        throw new Error("Daily withdrawal limit reached.");
                    }

                    // Update user balance
                    const newBalance = currentBalance - amount;
                    transaction.update(userRef, { balance: newBalance });

                    // Create withdrawal request
                    transaction.set(withdrawalRef, {
                        uid: currentUID,
                        amount: amount,
                        method: selectedMethod,
                        payment_details: details, 
                        status: 'processing', 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        order_number: orderNumber,
                        date_string: today, // Crucial for daily limit check
                    });
                });

                showToast(`Withdrawal request for ₹${formatCurrency(amount)} successful!`, 'success');
                
                // Update local state and UI
                userBalance -= amount;
                availableBalanceEl.textContent = formatCurrency(userBalance);
                withdrawableBalanceEl.textContent = formatCurrency(userBalance);
                
                fetchWithdrawalHistory(); 
                calculateRemainingWithdrawals(currentUID); // Recalculate remaining withdrawals
                withdrawalAmountInput.value = ''; 

            } catch (error) {
                console.error("Withdrawal failed:", error);
                let message = 'Withdrawal Failed. Please check limits or try again.';
                if (error.message.includes('Insufficient funds')) {
                    message = 'Withdrawal Failed: Insufficient balance in account.';
                } else if (error.message.includes('Daily withdrawal limit reached')) {
                    message = 'Withdrawal Failed: Daily withdrawal limit reached.';
                }
                showToast(message, 'error');
            } finally {
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'Withdraw';
                updateWithdrawalDetails();
            }
        }

// --- FETCH WITHDRAWAL HISTORY (SAFE MODE + LATEST FIRST) ---
async function fetchWithdrawalHistory() {
  if (!currentUID) {
    historyListEl.innerHTML = '';
    noHistoryMessageEl.style.display = 'block';
    noHistoryMessageEl.textContent = 'Please log in to view history.';
    return;
  }

  historyListEl.innerHTML = '';
  noHistoryMessageEl.style.display = 'block';
  noHistoryMessageEl.textContent = 'Loading history...';

  try {
    // Try normal query with orderBy (needs index)
    const snapshot = await db.collection('withdrawal_requests')
      .where('uid', '==', currentUID)
      .orderBy('timestamp', 'desc')
      .limit(5)
      .get();

    renderHistory(snapshot.docs);
  } catch (error) {
    console.warn("⚠️ Index missing — switching to safe mode fallback.", error);

    try {
      // Fallback: fetch without orderBy (no index required)
      const snapshot = await db.collection('withdrawal_requests')
        .where('uid', '==', currentUID)
        .get();

      // Manually sort by timestamp DESC (latest first)
      const sortedDocs = snapshot.docs.sort((a, b) => {
        const t1 = a.data().timestamp?.toMillis?.() || 0;
        const t2 = b.data().timestamp?.toMillis?.() || 0;
        return t2 - t1; // latest first
      });

      renderHistory(sortedDocs);
    } catch (fallbackError) {
      console.error("❌ Fallback failed:", fallbackError);
      noHistoryMessageEl.style.display = 'block';
      noHistoryMessageEl.textContent = 'Failed to load withdrawal history.';
    }
  }
}

// --- RENDER HISTORY LIST (UPDATED FOR CORRECT TYPE AND COLOR) ---
function renderHistory(docs) {
  const historyListEl = document.getElementById('withdrawalHistoryList');
  const noHistoryMessageEl = document.getElementById('noHistoryMessage');
  
  historyListEl.innerHTML = '';

  if (!docs || docs.length === 0) {
    noHistoryMessageEl.style.display = 'block';
    noHistoryMessageEl.textContent = 'No withdrawal history found.';
    return;
  }

  noHistoryMessageEl.style.display = 'none';

  docs.forEach(doc => {
    const item = doc.data();
    
    // --- UPDATED LOGIC HERE: Change 'complete' to 'success' for green color ---
    let statusDisplay = item.status;
    if (statusDisplay === 'complete') {
        statusDisplay = 'success'; 
    }
    // --------------------------------------------------------------------------

    // Use the statusDisplay variable to pick the CSS class
    const statusClass = `status-${statusDisplay}`;
    
    // Use the original status value for the text displayed to the user (e.g., 'Processing', 'Complete', 'Rejected')
    const statusText = item.status
      ? item.status.charAt(0).toUpperCase() + item.status.slice(1)
      : 'Unknown';

    // Format Date and Time
    const date = item.timestamp?.toDate?.() || new Date();
    // Format: DD-MM-YYYY HH:MM:SS
    const dateTimeString = `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()} ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}`;
    
    // Determine the value for 'Type' - ONLY METHOD NAME
    let typeValue = (item.method === 'bankcard') ? 'Bank Card' : (item.method?.toUpperCase?.() || 'N/A');

    const listItem = document.createElement('li');
    // Using a class for the card style
    listItem.className = 'history-item-card';
    
    // --- HTML STRUCTURE FOR THE CARD/GRID LAYOUT ---
    listItem.innerHTML = `
      <div class="history-top-row">
        <span class="history-amount">₹${formatCurrency(item.amount || 0)}</span>
        <span class="history-status-right ${statusClass}">${statusText}</span>
      </div>
      
      <div class="history-details-grid">
        <span class="grid-label type">Type</span>
        <span class="grid-value type-value">${typeValue}</span>
        
        <span class="grid-label">Time</span>
        <span class="grid-value time-value">${dateTimeString}</span>
        
        <span class="grid-label">Order No.</span>
        <span class="grid-value order-no-value">${item.order_number || doc.id}</span>
      </div>
    `;
    // --- END MODIFIED SECTION ---
    
    historyListEl.appendChild(listItem);
  });
}
        window.fetchWithdrawalHistory = fetchWithdrawalHistory;


        // --- INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", function() {
            currentUID = getLoggedInUserUID();
            
            if (!currentUID) {
                showToast('User not logged in. Please log in.', 'error');
                return;
            }

            fetchBalance(); 
            fetchWithdrawalHistory();
            
            selectMethod('bankcard'); 
            
            // Close modal when user clicks anywhere outside of it
            window.onclick = function(event) {
                if (event.target == addDetailsModal || event.target == passwordModal) {
                    // Note: Closing payment modal can be confusing if user tries to save and validation fails.
                    // It's safer to only allow closing password modal by outside click or explicit cancel button.
                    // For now, keeping the original behavior but noting the potential issue.
                    // closeAddDetailsModal(); // Removed this line for addDetailsModal for better UX
                }
            }
        });

    </script>
</body>
</html>
